<?xml version="1.0" encoding="UTF-8"?>

<xwikidoc>
  <web>TotemCode</web>
  <name>TotemSheet</name>
  <language/>
  <defaultLanguage/>
  <translation>0</translation>
  <parent>TotemCode.TotemClass</parent>
  <creator>xwiki:XWiki.Admin</creator>
  <author>xwiki:XWiki.Admin</author>
  <customClass/>
  <contentAuthor>xwiki:XWiki.Admin</contentAuthor>
  <creationDate>1399932000000</creationDate>
  <date>1424657801000</date>
  <contentUpdateDate>1424657801000</contentUpdateDate>
  <version>1.1</version>
  <title>#if($doc.name == 'TotemSheet')Totem Sheet#{else}$services.display.title($doc, {'displayerHint': 'default'})#end</title>
  <defaultTemplate/>
  <validationScript/>
  <comment/>
  <minorEdit>false</minorEdit>
  <syntaxId>xwiki/2.1</syntaxId>
  <hidden>true</hidden>
  <object>
    <class>
      <name>XWiki.JavaScriptExtension</name>
      <customClass/>
      <customMapping/>
      <defaultViewSheet/>
      <defaultEditSheet/>
      <defaultWeb/>
      <nameField/>
      <validationScript/>
      <cache>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>select</displayType>
        <multiSelect>0</multiSelect>
        <name>cache</name>
        <number>5</number>
        <prettyName>Caching policy</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator> </separator>
        <separators> ,|</separators>
        <size>1</size>
        <unmodifiable>0</unmodifiable>
        <values>long|short|default|forbid</values>
        <classType>com.xpn.xwiki.objects.classes.StaticListClass</classType>
      </cache>
      <code>
        <disabled>0</disabled>
        <name>code</name>
        <number>2</number>
        <prettyName>Code</prettyName>
        <rows>20</rows>
        <size>50</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.TextAreaClass</classType>
      </code>
      <name>
        <disabled>0</disabled>
        <name>name</name>
        <number>1</number>
        <prettyName>Name</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </name>
      <parse>
        <disabled>0</disabled>
        <displayFormType>select</displayFormType>
        <displayType>yesno</displayType>
        <name>parse</name>
        <number>4</number>
        <prettyName>Parse content</prettyName>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.BooleanClass</classType>
      </parse>
      <use>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>select</displayType>
        <multiSelect>0</multiSelect>
        <name>use</name>
        <number>3</number>
        <prettyName>Use this extension</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator> </separator>
        <separators> ,|</separators>
        <size>1</size>
        <unmodifiable>0</unmodifiable>
        <values>currentPage|onDemand|always</values>
        <classType>com.xpn.xwiki.objects.classes.StaticListClass</classType>
      </use>
    </class>
    <name>TotemCode.TotemSheet</name>
    <number>0</number>
    <className>XWiki.JavaScriptExtension</className>
    <guid>051ad43d-c5cc-4f31-9032-9fb070f3e28e</guid>
    <property>
      <cache>long</cache>
    </property>
    <property>
      <code>var XWiki = (function (XWiki) {
  var widgets = XWiki.widgets = XWiki.widgets || {};
  widgets.TotemEditor = Class.create({
  initialize: function() {
    this.hookEditOrder();
    $$('.totemBlocks .totemBlock').each(function(item){
      this.hookEditButton(item);
      this.hookEditSourceButton(item);
      this.hookDeleteButton(item);
    }.bind(this));
    
    this.hookAddButton();
  },
  
  hookEditOrder : function () {
    // find the editorder form
    var editForm = $$('form.editorderform')[0];
    if (!editForm) {
      return;
    }
    this.editOrderForm = editForm;
    // find the input
    // this name is not always the same here, but will work in 80% of the cases, at least
    var orderInput = editForm.down("input[name='TotemCode.TotemClass_0_blockOrder']")
    if (!orderInput) {
      return;
    }
    this.blockOrderInput = orderInput;
    this.setupDragDrop();
    // hide the input and disable the save button until a change is made
    this.blockOrderInput.addClassName('hidden');
    // find the button and disable it
    var saveButton = editForm.down('input[type=submit]');
    if (saveButton) {
      saveButton.writeAttribute('disabled', 'disabled');
    }
  },
  
  setupDragDrop : function() {
    var onMove = this.onBlockMoved.bind(this);
    Sortable.create('totemBlocks', {
      tag: 'div',
      only: 'totemBlock',
      handle: 'blocktitle', 
      overlap: 'vertical', 
      scroll: window, 
      dropOnEmpty: true, 
      constraint: false,
      ghosting: false,
      hoverclass: 'blocktitle-hover-highlight',
      onUpdate: onMove
    });
  },
  
  onBlockMoved : function() {
    // write the new block order
    var newBlockOrder = $$('.totemBlock').collect(function(item) { return item.readAttribute('id').substring(11); }).join(',');
    this.blockOrderInput.value = newBlockOrder;
    // enable the save button
    var saveButton = this.editOrderForm.down('input[type=submit]');
    if (saveButton) {
      saveButton.writeAttribute('disabled', false);
    }
  },
  
  hookEditButton : function(totemBlockItem) {
    // find the edit button in the actions
    var editButton = totemBlockItem.down('.editactions .editbutton');
    if (!editButton) {
      return;
    }
    editButton.observe('click', function(event) {
      // find the edit form and show it
      var editForm = totemBlockItem.down('.editblockform');
      if (!editForm) {
        return;
      }
      // we have an edit form, stop the event
      event.stop();
      editForm.removeClassName('hidden');
      var blockDisplayer = totemBlockItem.down('.blockdisplayer');
      if (blockDisplayer) {
        blockDisplayer.addClassName('hidden');
      }
      var editSourceForm = totemBlockItem.down('.editsourceblockform');
      if (editSourceForm) {
        editSourceForm.addClassName('hidden');
      }
    });
    // find the cancel button of this edit form and make it hide the form
    var cancelButton = totemBlockItem.down('.editblockform a.cancelbutton');
    if (cancelButton) {
      cancelButton.observe('click', function(event){
        var editForm = event.findElement('.editblockform');
        if (!editForm) {
          return;
        }
        event.stop();
        editForm.addClassName('hidden');
        var blockDisplayer = totemBlockItem.down('.blockdisplayer');
        if (blockDisplayer) {
          blockDisplayer.removeClassName('hidden');
        }
      }.bind(this));
    }
  },
  
  hookEditSourceButton : function(totemBlockItem) {
    // find the edit button in the actions
    var editSourceButton = totemBlockItem.down('.editactions .editsourcebutton');
    if (!editSourceButton) {
      return;
    }
    editSourceButton.observe('click', function(event) {
      // find the edit form and show it
      var editSourceForm = totemBlockItem.down('.editsourceblockform');
      if (!editSourceForm) {
        return;
      }
      // we have an edit form, stop the event
      event.stop();
      editSourceForm.removeClassName('hidden');
      var blockDisplayer = totemBlockItem.down('.blockdisplayer');
      if (blockDisplayer) {
        blockDisplayer.addClassName('hidden');
      }
      var editForm = totemBlockItem.down('.editblockform');
      if (editForm) {
        editForm.addClassName('hidden');
      }
    });
    // find the cancel button of this edit form and make it hide the form
    var cancelButton = totemBlockItem.down('.editsourceblockform a.cancelbutton');
    if (cancelButton) {
      cancelButton.observe('click', function(event){
        var editForm = event.findElement('.editsourceblockform');
        if (!editForm) {
          return;
        }
        event.stop();
        editForm.addClassName('hidden');
        var blockDisplayer = totemBlockItem.down('.blockdisplayer');
        if (blockDisplayer) {
          blockDisplayer.removeClassName('hidden');
        }
      }.bind(this));
    }
  },
  
  hookDeleteButton : function(totemBlockItem) {
    // get the delete form and add a conversation message to the submit
    var deleteForm = totemBlockItem.down('form.removeblockform');
    deleteForm.observe('submit', function(event){
      event.stop();
      var _this = event.findElement('form.removeblockform');
      new XWiki.widgets.ConfirmationBox(
        {
          onYes : function() {_this.submit();},
        },
        {confirmationText: "$msg.get('totem.edit.removeitem.confirmation')",}
        )
    }.bind(this));
  },
  
  hookAddButton : function() {
    // find the edit button in the actions
    var addButton = $$('.addactions a.addblock')[0];
    if (!addButton) {
      return;
    }
    addButton.observe('click', function(event) {
      // find the edit form and show it
      var addForm = $$('.addblockform')[0];
      if (!addForm) {
        return;
      }
      // we have an edit form, stop the event
      event.stop();
      addForm.removeClassName('hidden');
    });
    // find the cancel button of this add form and make it hide the form
    var cancelButton = $$('.addblockform a.cancelbutton')[0];
    if (cancelButton) {
      cancelButton.observe('click', function(event){
        var addForm = event.findElement('.addblockform');
        if (!addForm) {
          return;
        }
        event.stop();
        addForm.addClassName('hidden');
      }.bind(this));
    }
  }
});
  return XWiki;
}(XWiki || {}));

document.observe('xwiki:dom:loading', function() {
  new XWiki.widgets.TotemEditor();
});</code>
    </property>
    <property>
      <name>Totem javascript</name>
    </property>
    <property>
      <parse>1</parse>
    </property>
    <property>
      <use>onDemand</use>
    </property>
  </object>
  <object>
    <class>
      <name>XWiki.JavaScriptExtension</name>
      <customClass/>
      <customMapping/>
      <defaultViewSheet/>
      <defaultEditSheet/>
      <defaultWeb/>
      <nameField/>
      <validationScript/>
      <cache>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>select</displayType>
        <multiSelect>0</multiSelect>
        <name>cache</name>
        <number>5</number>
        <prettyName>Caching policy</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator> </separator>
        <separators> ,|</separators>
        <size>1</size>
        <unmodifiable>0</unmodifiable>
        <values>long|short|default|forbid</values>
        <classType>com.xpn.xwiki.objects.classes.StaticListClass</classType>
      </cache>
      <code>
        <disabled>0</disabled>
        <name>code</name>
        <number>2</number>
        <prettyName>Code</prettyName>
        <rows>20</rows>
        <size>50</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.TextAreaClass</classType>
      </code>
      <name>
        <disabled>0</disabled>
        <name>name</name>
        <number>1</number>
        <prettyName>Name</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </name>
      <parse>
        <disabled>0</disabled>
        <displayFormType>select</displayFormType>
        <displayType>yesno</displayType>
        <name>parse</name>
        <number>4</number>
        <prettyName>Parse content</prettyName>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.BooleanClass</classType>
      </parse>
      <use>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>select</displayType>
        <multiSelect>0</multiSelect>
        <name>use</name>
        <number>3</number>
        <prettyName>Use this extension</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator> </separator>
        <separators> ,|</separators>
        <size>1</size>
        <unmodifiable>0</unmodifiable>
        <values>currentPage|onDemand|always</values>
        <classType>com.xpn.xwiki.objects.classes.StaticListClass</classType>
      </use>
    </class>
    <name>TotemCode.TotemSheet</name>
    <number>1</number>
    <className>XWiki.JavaScriptExtension</className>
    <guid>7ceb9a37-4b00-4549-806f-6e2c62429505</guid>
    <property>
      <cache>long</cache>
    </property>
    <property>
      <code>document.observe('xwiki:dom:loading', function() {
// Configure require.js to use Colpick (https://github.com/josedvq/colpick-jQuery-Color-Picker/)
require.config({
  paths: {
    'colpick': '$services.webjars.url('colpick/2.0.2/js/colpick.js')'
  },
  shim: {
    'colpick' : ['jquery']
  }
});
// Beginning of the script
require(['jquery', 'colpick'], function($, Colpick) {

  // Get the inputs that need to be enhanced
  var inputs = $('.color-picker');
  
  // For each input
  for (var i=0; i&lt;inputs.length; ++i) {
    var input = $(inputs[i]);
    var parent = input.parent();
    
    // Create the color preview box
    parent.append('&lt;span class="input-group-addon"&gt;&lt;span class="color-preview"&gt;&lt;/span&gt;&lt;/span&gt;');
    
    // Update the color preview box
    parent.find('.color-preview').css('background-color', input.val());
    
    // Enable the color picker
    input.colpick({
      layout: 'hex',
      submit: true,
      color: input.val(),
      onSubmit: function(hsb, hex, rgb, el) {
        var element = $(el);
        // Hide the color picker
        element.colpickHide();
        // Update the filled value
        element.val('#'+hex);
        // Update the color preview box
        element.parent().find('.color-preview').css('background-color', '#'+hex);
        // Emit the "change" event
        element.trigger('change');
      }
    });
    
    // If the user write a value manually
    input.keyup(function(event){
      var element = $(event.target);
      // Update the color preview box
      element.parent().find('.color-preview').css('background-color', element.val());
      // Update the color picker
      element.colpickSetColor(element.val(), false);
    });
  }
  
  // Hide the color picker if the user scrolls
  $('.tab-content').scroll(function(){
    // For each input
    for (var i=0; i&lt;inputs.length; ++i) {
      var input = inputs[i];
      $(input).colpickHide();
    }
  });
});

});</code>
    </property>
    <property>
      <name>Color picker</name>
    </property>
    <property>
      <parse>1</parse>
    </property>
    <property>
      <use>onDemand</use>
    </property>
  </object>
  <object>
    <class>
      <name>XWiki.JavaScriptExtension</name>
      <customClass/>
      <customMapping/>
      <defaultViewSheet/>
      <defaultEditSheet/>
      <defaultWeb/>
      <nameField/>
      <validationScript/>
      <cache>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>select</displayType>
        <multiSelect>0</multiSelect>
        <name>cache</name>
        <number>5</number>
        <prettyName>Caching policy</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator> </separator>
        <separators> ,|</separators>
        <size>1</size>
        <unmodifiable>0</unmodifiable>
        <values>long|short|default|forbid</values>
        <classType>com.xpn.xwiki.objects.classes.StaticListClass</classType>
      </cache>
      <code>
        <disabled>0</disabled>
        <name>code</name>
        <number>2</number>
        <prettyName>Code</prettyName>
        <rows>20</rows>
        <size>50</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.TextAreaClass</classType>
      </code>
      <name>
        <disabled>0</disabled>
        <name>name</name>
        <number>1</number>
        <prettyName>Name</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </name>
      <parse>
        <disabled>0</disabled>
        <displayFormType>select</displayFormType>
        <displayType>yesno</displayType>
        <name>parse</name>
        <number>4</number>
        <prettyName>Parse content</prettyName>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.BooleanClass</classType>
      </parse>
      <use>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>select</displayType>
        <multiSelect>0</multiSelect>
        <name>use</name>
        <number>3</number>
        <prettyName>Use this extension</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator> </separator>
        <separators> ,|</separators>
        <size>1</size>
        <unmodifiable>0</unmodifiable>
        <values>currentPage|onDemand|always</values>
        <classType>com.xpn.xwiki.objects.classes.StaticListClass</classType>
      </use>
    </class>
    <name>TotemCode.TotemSheet</name>
    <number>2</number>
    <className>XWiki.JavaScriptExtension</className>
    <guid>31a5edfd-5305-444c-b817-fc604f35a422</guid>
    <property>
      <cache>long</cache>
    </property>
    <property>
      <code>document.observe('xwiki:dom:loaded', function() {
  // Use JQuery
  require(['jquery'], function($) {
    // The following script will allow to update the hidden input data with the specific additional data for displayers
    // Additonal Datas are displayed as individual input and are all saved in a common textarea field.
    // ****
    function updateHiddenInputData() {
      // get displayer additonal data inputs
      var additionalDataInputList = $('.displayerAdditionalData');
      additionalDataInputList.each( function() {
        // observe Change event
        $(this).change(function() {
          var dataValues = "";
          // get the list of input with class .displayerAdditionalData from the parent
          var additionalDataParent = $(this).parent().parent();
          var total = additionalDataParent.find('.displayerAdditionalData').length;
          additionalDataParent.find('.displayerAdditionalData').each( function(index) {
            // store field data
            dataValues += $(this).attr('name') + ":" + $(this).val();
            if (index != total - 1) {
              dataValues += ",";
            }
          });
          // update the data hidden input
          additionalDataParent.find('input[type=hidden]').val(dataValues);
        });
      });
    }
    // call our updateHiddenInputData function
    updateHiddenInputData();
    updateHiddenInputData();
    updateHiddenInputData();
    // update the additional specific to match the selected displayer
    $("select[id*='type']").change( function() {
      // get the addtional data container
      var additionalDataDiv = $(this).parents().eq(2).find('.additionalData');
      // TotemCode.TotemAdditionalDataDisplayer page is used to build the displayer specific input
      // we build the url to access it
      var additionalDataDisplayerUrl = "$xwiki.getURL('TotemCode.TotemAdditionalDataDisplayer', 'get', '')?totem=" + $(this).val();
      additionalDataDisplayerUrl += "&amp;totemBlock=" + $(this).closest(".totemBlock").attr("id")
      // then we call it in ajax
      $.ajax({
        url: additionalDataDisplayerUrl,
      }).done(function( html ) {
        // update the additionalData container
        $(additionalDataDiv).html(html);
        // bind the new inputs
        updateHiddenInputData();
      });
    });
  });
});



</code>
    </property>
    <property>
      <name>Displayer additional Data </name>
    </property>
    <property>
      <parse>1</parse>
    </property>
    <property>
      <use>currentPage</use>
    </property>
  </object>
  <object>
    <class>
      <name>XWiki.StyleSheetExtension</name>
      <customClass/>
      <customMapping/>
      <defaultViewSheet/>
      <defaultEditSheet/>
      <defaultWeb/>
      <nameField/>
      <validationScript/>
      <cache>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>select</displayType>
        <multiSelect>0</multiSelect>
        <name>cache</name>
        <number>5</number>
        <prettyName>Caching policy</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator> </separator>
        <separators> ,|</separators>
        <size>1</size>
        <unmodifiable>0</unmodifiable>
        <values>long|short|default|forbid</values>
        <classType>com.xpn.xwiki.objects.classes.StaticListClass</classType>
      </cache>
      <code>
        <disabled>0</disabled>
        <name>code</name>
        <number>2</number>
        <prettyName>Code</prettyName>
        <rows>20</rows>
        <size>50</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.TextAreaClass</classType>
      </code>
      <contentType>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>select</displayType>
        <multiSelect>0</multiSelect>
        <name>contentType</name>
        <number>6</number>
        <prettyName>Content Type</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator> </separator>
        <separators> ,|</separators>
        <size>1</size>
        <unmodifiable>0</unmodifiable>
        <values>CSS|LESS</values>
        <classType>com.xpn.xwiki.objects.classes.StaticListClass</classType>
      </contentType>
      <name>
        <disabled>0</disabled>
        <name>name</name>
        <number>1</number>
        <prettyName>Name</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </name>
      <parse>
        <disabled>0</disabled>
        <displayFormType>select</displayFormType>
        <displayType>yesno</displayType>
        <name>parse</name>
        <number>4</number>
        <prettyName>Parse content</prettyName>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.BooleanClass</classType>
      </parse>
      <use>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>select</displayType>
        <multiSelect>0</multiSelect>
        <name>use</name>
        <number>3</number>
        <prettyName>Use this extension</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator> </separator>
        <separators> ,|</separators>
        <size>1</size>
        <unmodifiable>0</unmodifiable>
        <values>currentPage|onDemand|always</values>
        <classType>com.xpn.xwiki.objects.classes.StaticListClass</classType>
      </use>
    </class>
    <name>TotemCode.TotemSheet</name>
    <number>0</number>
    <className>XWiki.StyleSheetExtension</className>
    <guid>ad3ccc13-bcaf-4352-82cc-4f076e90b678</guid>
    <property>
      <cache>long</cache>
    </property>
    <property>
      <code>.totemBlock .removeblockform {
  display: inline;
}

.totemBlock .editactions {
  /*text-align: right;*/
}

.totemBlocksEdit .blocktitle {
   cursor: move;
}
</code>
    </property>
    <property>
      <contentType>CSS</contentType>
    </property>
    <property>
      <name>Totem editor stylesheet</name>
    </property>
    <property>
      <parse>1</parse>
    </property>
    <property>
      <use>onDemand</use>
    </property>
  </object>
  <content>{{include document="DisplayerCode.DisplayerMacros" /}}

{{velocity output="false"}}
#macro(displayTotemBlock $totemBlock $withEdit $cancelURL $editURL $totemItemClass $sheetFieldsMapping $totemItemsURL)
  #set( $isBlockFullscreen = $doc.getObject('TotemCode.TotemClass').getProperty('fullscreen').value )
  #set( $blockContentSize = $doc.getObject('TotemCode.TotemClass').getProperty('contentSize').value )
  #set( $totemBlockContentStyle = '' )
  #if( ${isBlockFullscreen} == 1 &amp;&amp; "${blockContentSize}" != "")
    #set( $totemBlockContentStyle = "max-width: ${blockContentSize}px; margin: 0 auto;" )
  #end
    (%class="totemBlockContent" style="${totemBlockContentStyle}"%)(((
      ## display the block. get its values and then call the displayer macro
      #set($totemBlockSheet = $totemBlock.getProperty('type').value)  
      ## Case of item coming from application
      #if("${totemBlock.getProperty('appsource_app').value}" != "" &amp;&amp; "${totemBlock.getProperty('appsource_app').value.size()}" != "0")
        ## create field mapping with data filled by the user
        #set($sourceClassFieldsMapping = {})
        #set($discard = $sourceClassFieldsMapping.put("description", "${totemBlock.getProperty('appsource_description').value}"))
        #set($discard = $sourceClassFieldsMapping.put("date", "${totemBlock.getProperty('appsource_date').value}"))
        #set($discard = $sourceClassFieldsMapping.put("image", "${totemBlock.getProperty('appsource_image').value}"))
        #set($discard = $sourceClassFieldsMapping.put("url", "${totemBlock.getProperty('appsource_url').value}"))
        ## We use item from application, sourceType = 'sourceClass'
        #displayBlock($totemBlockSheet, '', $totemBlock.getProperty('title').value, $totemBlock.getProperty('footer').value, 'sourceClass', '', $!{totemBlock.getProperty('appsource_app').value.get(0)}, 0, $sourceClassFieldsMapping )
      #else
        ## We use the items list using sourceType as doclist
        #displayBlock($totemBlockSheet, '', $totemBlock.getProperty('title').value, $totemBlock.getProperty('footer').value, 'doclist', $totemBlock.getProperty('source').value, $totemItemClass, 0, $sheetFieldsMapping.get($totemBlockSheet))
      #end 
      #if($withEdit)
        ## load the css used by the color picker input in edit mode
        #set($discard = $xwiki.linkx.use($services.webjars.url('colpick/2.0.2/css/colpick.css'), {'rel': 'stylesheet'}))
        (%class="#if("$!request.editblock" != "$totemBlock.number")hidden#end editblockform"%)(((
          #displayTotemBlockEditForm($totemBlock, false, $cancelURL, $editURL, $totemItemClass)
        )))
        (%class="#if("$!request.editblocksource" != "$totemBlock.number")hidden#end editsourceblockform"%)(((
          #displayTotemBlockEditSourceForm($totemBlock, $totemItemsURL, $cancelURL, $editURL)
        )))
      #end
      #if($withEdit)
        (%class="editactions"%)((({{html clean="false"}}
        &lt;a href="$escapetool.xml($doc.getURL('view', "showEdit=true&amp;editblock=${totemBlock.number}"))" class="editbutton"&gt;$msg.get('totem.edit.editblock.button')&lt;/a&gt;
        &lt;a href="$escapetool.xml($doc.getURL('view', "showEdit=true&amp;editblocksource=${totemBlock.number}"))" class="editsourcebutton"&gt;$msg.get('totem.edit.editblocksource.button')&lt;/a&gt;
        #displayTotemBlockRemoveForm($totemBlock, $cancelURL, $editURL){{/html}})))
      #end
    )))
#end

#macro(getDisplayerAdditionalDataInMap $totemItemAdditionalDataObjects $totemBlockStoredData)
  ## Read stored data
  #set( $totemBlockStoredDataMap = {} )
  #foreach( $dataLine in $!{totemBlockStoredData.replaceAll("\r", "").replaceAll("\n", "").replaceAll(" ", "").split(",")} )
  #set( $dkey = "" )
  #set( $dvalue = "" )
    #foreach( $d in ${dataLine.split(":")})
      #if( ${foreach.index} == 0 )
        #set( $dkey = "$!{d}" )
      #else
        #set( $dvalue = "$!{d}" )
      #end
    #end
    #set( $discard = $totemBlockStoredDataMap.put("${dkey}","${dvalue}") )
  #end
  ## Set additional data from displayer keys
  #set( $displayerAdditionalDataMap = {}) ## Map
  #foreach( $additionalData in $!{totemItemAdditionalDataObjects})
    #set( $discard = $displayerAdditionalDataMap.put("${additionalData.key}","$!{totemBlockStoredDataMap.get(${additionalData.key})}") )
  #end
#end

#macro(displayTotemBlockEditForm $totemBlock $isNewBlock $cancelURL $editURL, $totemItemClass)
  #set($formAction = "$doc.getURL('save')")
  #if ($isNewBlock)
    #set($formAction = "$doc.getURL('objectadd')")
  #end
  {{html clean="false"}}
    &lt;form action="$formAction" method="post" class="xform"&gt;
    &lt;input type="hidden" name="form_token" value="$!{services.csrf.getToken()}" /&gt;
    &lt;input type="hidden" name="xredirect" value="$escapetool.xml($editURL)" /&gt;
    #if ($isNewBlock)
      &lt;input type="hidden" name="classname" value="TotemCode.TotemBlockClass" /&gt;
    #end
  {{/html}}
  ## display the totem editable properties
  #set($totemBlockClass = $totemBlock.xWikiClass)
  #foreach ($propName in ['type', 'title', 'size']) ## - footer, data
    ; $doc.displayPrettyName($propName, $totemBlock)
    : #if($isNewBlock){{html clean="false"}}$doc.displayEdit($totemBlockClass.get($propName), 'TotemCode.TotemBlockClass_', $totemBlock){{/html}}
      #else$doc.display($propName, 'edit', $totemBlock)
      #end
     #set($discard = $xwiki.jsx.use('TotemCode.TotemSheet'))
  #end
    ## Background-color Custom input in order to display the color picker. Note : add color-picker class with javascript
    ; $doc.displayPrettyName('background-color', $totemBlock)
    {{html clean=false}}
    #if ($isNewBlock)
      &lt;input id="TotemCode.TotemBlockClass_background-color" type="text" name="TotemCode.TotemBlockClass_background-color" class="color-picker" value="$!{escapetool.xml($!doc.getValue('background-color', ${totemBlock}))}"&gt;
    #else
      &lt;input id="TotemCode.TotemBlockClass_${totemBlock.number}_background-color" type="text" name="TotemCode.TotemBlockClass_${totemBlock.number}_background-color" class="color-picker" value="$!{escapetool.xml($!doc.getValue('background-color', ${totemBlock}))}"&gt;
    #end
    {{/html}}
    ## Background-image Custom input to use an attachment selector
    ; $doc.displayPrettyName('background-image', $totemBlock)
    {{attachmentSelector classname="${totemBlockClass.name}" object="${totemBlock.number}" property="background-image" savemode="direct"
displayImage="false" link="true" filter="png,jpg,gif"/}}
     ## Background-image Custom input to use an attachment selector
    ; $doc.displayPrettyName('background-video', $totemBlock)
    {{attachmentSelector classname="${totemBlockClass.name}" object="${totemBlock.number}" property="background-video" savemode="direct"
displayImage="false" link="true" filter="mp4, avi, mpg"/}}
    ## Add additional specific data from the displayer
    #set( $totemItemAdditionalDataObjects = $xwiki.getDocument("DisplayerCode.${totemBlock.type}").getObjects('TotemCode.TotemItemAdditionalDataClass') )
    #getDisplayerAdditionalDataInMap($totemItemAdditionalDataObjects $!doc.getValue('data', ${totemBlock}))
    (%class="additionalData" id %)(((
    #foreach( $additionalData in $!{totemItemAdditionalDataObjects} )
      ; $additionalData.key
    {{html clean=false}}
      &lt;input id="${additionalData.key}_${totemBlock.number}" type="text" name="${additionalData.key}" value="$!{displayerAdditionalDataMap.get(${additionalData.key})}" class="displayerAdditionalData"&gt;
    {{/html}}
    #end
    {{html clean=false}}
    &lt;input type="hidden" id="TotemCode.TotemBlockClass_${totemBlock.number}_data" name="TotemCode.TotemBlockClass_${totemBlock.number}_data" value="$escapetool.xml($!doc.getValue('data', ${totemBlock}))"/&gt;
    {{/html}}
    )))
  {{html clean="false"}}
    &lt;div class="buttonwrapper"&gt;
      &lt;input type="submit" value="$msg.get('save')" class="button" /&gt;
      &lt;a href="$cancelURL" class="cancelbutton"&gt;$msg.get('cancel')&lt;/a&gt;
    &lt;/div&gt;
    &lt;/form&gt;
  {{/html}}
#end

#macro(displayTotemBlockEditSourceForm $totemBlock $totemItemsURL $cancelURL $editURL)
  {{container layoutStyle="columns"}}
  (((
    #set($formAction = "$doc.getURL('save')")
    {{html clean="false"}}
      &lt;form action="$formAction" method="post" class="xform"&gt;
      &lt;input type="hidden" name="form_token" value="$!{services.csrf.getToken()}" /&gt;
      &lt;input type="hidden" name="xredirect" value="$escapetool.xml($editURL)" /&gt;
    {{/html}}
    ## display the totem source properties
    #set($totemBlockClass = $totemBlock.xWikiClass)
    #foreach ($propName in ['source'])
      ; $doc.displayPrettyName($propName, $totemBlock)
      : $doc.display($propName, 'edit', $totemBlock)
    #end
    **For advanced user only :**
    #foreach ($propName in ['appsource_app', 'appsource_date', 'appsource_description', 'appsource_image', 'appsource_url'])
      ; $doc.displayPrettyName($propName, $totemBlock)
      : $doc.display($propName, 'edit', $totemBlock)
    #end
    {{html clean="false"}}
      &lt;div class="buttonwrapper"&gt;
        &lt;input type="submit" value="$msg.get('save')" class="button" /&gt;
        &lt;a href="$cancelURL" class="cancelbutton"&gt;$msg.get('cancel')&lt;/a&gt;
      &lt;/div&gt;
      &lt;/form&gt;
    {{/html}}
  )))
  (((
  {{info}}$msg.get('totem.edit.editblocksource.help'){{/info}}

  (%class="buttonwrapper"%)[[$msg.get('totem.edit.editblocksource.itemslink')&gt;&gt;path:$totemItemsURL||class="button" rel="__blank"]](%%)
  )))
  {{/container}}
#end

#macro(displayTotemBlockRemoveForm $totemBlock $cancelURL $editURL)
  &lt;form action="$doc.getURL('objectremove')" method="post" class="removeblockform"&gt;
    &lt;span&gt;
      &lt;input type="hidden" name="classname" value="TotemCode.TotemBlockClass" /&gt;
      &lt;input type="hidden" name="classid" value="$totemBlock.number" /&gt;
      &lt;input type="hidden" name="cancelURL" value="$escapetool.xml($cancelURL)" /&gt;
      &lt;input type="hidden" name="xredirect" value="$escapetool.xml($editURL)" /&gt;
      &lt;input type="hidden" name="form_token" value="$!{services.csrf.getToken()}" /&gt;
   &lt;/span&gt;
  &lt;input type="submit" value="$msg.get('totem.edit.removeitem.button')" class="deletebutton" /&gt;
  &lt;/form&gt;
#end

#macro(displayEditTotemConfigurationForm)
  {{html clean="false" wiki="true"}}
    &lt;form action="$doc.getURL('save')" method="post"&gt;
    &lt;fieldset&gt;
      &lt;input type="hidden" name="xredirect" value="$escapetool.xml($editURL)" /&gt;
      &lt;input type="hidden" name="form_token" value="$!{services.csrf.getToken()}" /&gt;
    &lt;/fieldset&gt;
    #set($totemObject = $doc.getObject('TotemCode.TotemClass'))
    enable fullscreen : $totemObject.display('fullscreen','edit')&lt;br&gt;
    content size : $totemObject.display('contentSize','edit') px (not applied if empty)
    &lt;div class="buttonwrapper"&gt;
      &lt;input type="submit" value="$msg.get('Save Configuration')" class="button" /&gt;
    &lt;/div&gt;
  &lt;/form&gt;
  {{/html}}
#end

#macro(displayEditOrderForm $editURL)
  {{html clean="false" wiki="true"}}
    &lt;form action="$doc.getURL('save')" method="post" class="editorderform"&gt;
    &lt;fieldset&gt;
      &lt;input type="hidden" name="xredirect" value="$escapetool.xml($editURL)" /&gt;
      &lt;input type="hidden" name="form_token" value="$!{services.csrf.getToken()}" /&gt;
    &lt;/fieldset&gt;
    $doc.displayEdit($totemObject.xWikiClass.get('blockOrder'), "TotemCode.TotemClass_${totemObject.number}_", $totemObject)
    &lt;div class="buttonwrapper"&gt;
      &lt;input type="submit" value="$msg.get('totem.order.save')" class="button" /&gt;
    &lt;/div&gt;
  &lt;/form&gt;
  {{/html}}
#end
{{/velocity}}

{{velocity}}
#set($xwikipanelwidth = 0)
#set($rightPanelsWidth= 0)

## set a couple of constants that we want to be able to edit fast.
## 1/ class items of the totem
#set($totemItemClass = 'TotemCode.SimpleTotemItemClass')
## 2/ a couple of mappings between the different types of blocks and the items from this totem class that should be used. 
## TODO: Normally this should be demanded by the sheet somehow but I don't know exactly how for now :(
## NOTE: This approach base is no used for the moment
#set($sheetFieldsMapping = {'DisplayerCode.ListDisplayerSheet' : ['date', 'doc.title', 'url'],  'DisplayerCode.EvenementDisplayer' : ['image', 'doc.title', 'url']})
## 3/ the page where the items to be displayed in totem blocks are held: the page called items in the current space
#set($totemItemsURL = $xwiki.getURL('Items'))
## figure out if we're in edit mode. If we are but the document is loaded for editing in the wysiwyg, then pretend we're in view :) -- this makes include work
#set($isEdit = ($xcontext.action == "inline" || $xcontext.action == "edit") &amp;&amp; "$!request.xpage" != 'wysiwyginput')
#set($enableEdit = "$!request.showEdit" == "true")
#if (!$hasEdit)
  ## if user does not have edit right, editing is not enabled
  #set($enableEdit = false)
#end
## put the edit url in a var, so that we go to the edit mode using this url whenever needed
#set($editURL = $doc.getURL('view', 'showEdit=true'))
#if (!$isEdit)
  ## include the extra ssx / jsx for the totem, as set in the totem object
  #set($extraSSX = $doc.getObject('TotemCode.TotemClass').getProperty('ssx').value)
  #if("$!extraSSX" != "")
    #set($discard = $xwiki.ssx.use($extraSSX))
  #end
  #set($extraJSX = $doc.getObject('TotemCode.TotemClass').getProperty('jsx').value)
  #if("$!extraJSX" != "")
    #set($discard = $xwiki.jsx.use($extraJSX))
  #end
  ## if edit is enabled, add the jsx and the ssx of the totemsheet (for enhancements of the edit form)
  ## IMHO no ssx/jsx from the sheet should be needed in view mode, I don't see any totem generic styling that could be done in view mode: 
  ## displayers will do their styling for blocks, the extra jsx / ssx will handle styling specific to a particular totem.

    #set($discard = $xwiki.jsx.use('TotemCode.TotemSheet'))
  #if ($enableEdit)
    #set($discard = $xwiki.jsfx.use("js/scriptaculous/effects.js"))
    #set($discard = $xwiki.jsfx.use("js/scriptaculous/dragdrop.js"))
    #set($discard = $xwiki.jsx.use('TotemCode.TotemSheet', {'minify' : false}))
    #set($discard = $xwiki.ssx.use('TotemCode.TotemSheet', {'minify' : false}))
  #end
  ## pass the totem application fullscreen
  #set($enableFullscreen = $doc.getObject('TotemCode.TotemClass').getProperty('fullscreen').value)
  #if($enableFullscreen == 1 )
    #set($discard = $xwiki.ssx.use('TotemCode.TotemFullscreen', {'minify' : false}))  
    #set($discard = $xwiki.jsx.use('TotemCode.TotemFullscreen'))
  #end
  ## make up the cancel URL for the form cancellation and other cancels
  #set($cancelURL = $doc.getURL())
  #if ($enableEdit)
    ## if editing is enabled, forms should be cancelled to the base edit screen
    #set($cancelURL = $doc.getURL('view', 'showEdit=true'))
  #end
  ## if edit is enabled, add the input and form to save the order of the blocks which will be edited in js
  #if ($enableEdit)
    {{info}}
    #displayEditTotemConfigurationForm()
    {{/info}}
    ----
    {{info}}
    $msg.get('totem.edit.editorder.info')    
    #displayEditOrderForm($editURL)
    {{/info}}
  #end
  ## view mode of a totem
  ## get all the objects of type TotemBlockClass in the order defined in here and display them with the macro
  #set($blockNumbers = $doc.getObject('TotemCode.TotemClass').getProperty('blockOrder').value.split(','))
  ## remember the displayed blocks, so that we can display all undisplayed blocks after the order read
  #set($displayedBlocks = [])
  (%class="container-fluid"%)(((
    (%class="totemBlocks #if($enableEdit)totemBlocksEdit#end row" id="totemBlocks"%)(((
      #set($isOdd = true)
      #foreach($blockNumber in $blockNumbers)
        #set($intNumber = $mathtool.toInteger($blockNumber))
        #set($totemBlock = $doc.getObject('TotemCode.TotemBlockClass', $intNumber))
        #set($totemBlockSize = 12 )
        #if("${totemBlock.size}" != "")
          #set($totemBlockSize = ${totemBlock.size})
        #end
        #if ($totemBlock)
          #set($urlBackground = $doc.getAttachmentURL("${totemBlock.getValue('background-image')}"))
          (%class="totemBlock #if($isOdd)totemBlock-odd#{else}totemBlock-even#end col-sm-${totemBlockSize}" id="totemBlock_${totemBlock.number}" style="background:url(${urlBackground});  background-size: 100% 100%; background-color: ${totemBlock.background-color};  object-fit: cover;"%)(((
            #displayTotemBlock($totemBlock, $enableEdit, $cancelURL, $editURL $totemItemClass, $sheetFieldsMapping, $totemItemsURL)
          )))
          #set($discard = $displayedBlocks.add($totemBlock.number))
          #set($isOdd = !$isOdd)
        #end
      #end
      ## for all the blocks that were not displayed before, display them
      #foreach($totemLeftBlock in $doc.getObjects('TotemCode.TotemBlockClass'))
        #if(!$displayedBlocks.contains($totemLeftBlock.number))
          (%class="totemBlock #if($isOdd)totemBlock-odd#{else}totemBlock-even#end col-sm-${totemBlockSize}" id="totemBlock_${totemLeftBlock.number}" style="background:url(${urlBackground});  background-size: 100% 100%; background-color: ${totemBlock.background-color};  object-fit: cover;"%)(((
            #displayTotemBlock($totemLeftBlock, $enableEdit, $cancelURL, $editURL $totemItemClass, $sheetFieldsMapping, $totemItemsURL)
          )))
          #set($discard = $displayedBlocks.add($totemBlock.number))
          #set($isOdd = !$isOdd)
        #end
      #end
    )))
  )))

  ## add new block item form
  #if($enableEdit)
    (%class="addactions"%)(((
     [[$msg.get('totem.edit.additem.button')&gt;&gt;path:$doc.getURL('view', 'showEdit=true&amp;additem=true')||class="addblock"]]
      ## display a button to exit the edit form. TODO: move me in an appropriate place (where?)
     (%class="totemeditactions buttonwrapper"%)((([[$msg.get('totem.edit.exitedit')&gt;&gt;Totem.WebHome]])))
    )))
    (%class="#if("$!request.additem" != 'true')hidden#end addblockform"%)(((
      #set($fakeTotemBlock = $doc.newObject("TotemCode.TotemBlockClass"))    
      #displayTotemBlockEditForm($fakeTotemBlock, true, $cancelURL, $editURL)
    )))
  #end

  {{html clean="false"}}#template("textarea_wysiwyg.vm"){{/html}}
#else
  ## if we're in edit mode, send a redirect to the edit screen, since the totem has a special edit form (available in view).
  $response.sendRedirect("$editURL")
#end
{{/velocity}}

</content>
</xwikidoc>
